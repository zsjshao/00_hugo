+++
author = "zsjshao"
title = "01_OSI参考模型及TCPIP协议栈"
date = "2020-05-23"
tags = ["NA"]
categories = ["RS"]

+++

## 1、网格概述

### 1.1、什么是网络？

网络的本质就是实现资源共享

将各个系统联系到一起，形成信息传递、接收、共享的信息交互平台

![01_resource](http://images.zsjshao.net/rs/01-osi/01_resource.png)![01_internet](http://images.zsjshao.net/rs/01-osi/02_internet.png)



### 1.2、典型的园区网拓扑

![03_topo](http://images.zsjshao.net/rs/01-osi/03_topo.png)

在讲解TCP/IP基础之前，我们首先来看一张典型的校园网拓扑图，在图中我们可以看到，由交换机、路由器、防火墙等网络设备通过各种网络介质组成的校园网，在一个网络中，各个厂商的各种网络设备、包括我们的主机、服务器等其他终端之所以能够相互通信，协同工作，是因为所有设备都遵从相同的行为规则，这些行为规则的集合就构成了我们的通信模型

### 1.3、网络历史发展

#### 1.3.1、ARPA和ARPANET

1969年，美国国防部高级研究计划局ARPA（ Advanced Research Projects Agency ）以军用目的建立了名为ARPANET的计算机网络，它是世界上第一个封包交换网络，誉为互联网始祖。最初的“阿帕网”只连接了4个节点：

![04_university](http://images.zsjshao.net/rs/01-osi/04_university.png)

不过，“阿帕网” 问世之际，大部分电脑还互不兼容。于是，如何使硬件和软件都不同的电脑实现真正的互联，就是人们力图解决的难题。这个过程中，文顿·瑟夫为此做出首屈一指的贡献，从而被称为“互联网之父”。

```
ARPA 美国国防部高级研究计划署

加州大学洛杉矶分校
加州大学圣巴巴拉分校
斯坦福大学
犹他大学

ARPA是英文Advanced Research Projects Agency的缩写，代表美国国防部高级研究计划署。是美国国防部高级研究计划管理局因军事目的而建立的，开始时只连接了4台主机，这便是只有四个网点的网络之父

早期实验之后，技术重心转向-包交换技术。

作为RAND公司的研究成果，挑选J.C.R.lickder作为项目负责人，ARPA开始筹措资金来组建驱动式网络。资金投入方面的转变，开始由军方投资转向由学术计算中心投资。

1968年，ARPA与BBN（Bolt，Beranek和Newman）签订协议。BBN负责研究交换，网络则在网络分析公司进行设计。

实际网络与1969年建立起来的，它连接4个节点，当时的网络传输能力只有50Kbps，按标准来说就是非常的低。但无论如何，ARPANET变成了现实。第一个简单的纯文字系统的Internet。

从1970年开始，加入ARPANET的节点数不断的增加。

第一个公共性的ARPA展示出现在1972年的国际计算机通讯大会（ICCC）中。BBN编写第一个电子邮件程序，号召ARPA科学家协作，不久电子邮件应用于网络。

当时ARPANET使用的是NCP协议，它允许计算机相互交流，但目的地之外的网络和计算机却不分配地址，从而限制了未来增长的机会。1972年Robert Kahn来到ARPA，并提出了开放式网络框架，从而出现了大家熟知的TCP/IP（传输控制协议/网际协议）。

1983年1月1日，所有连入ARPANET的主机实现了从NCP向TCP/IP协议的转换。同在一时间段，ARPANET中分成了军事专用的MILNET和研究用途的ARPANET。
```

#### 1.3.2、Internet的由来

1985年，美国国家科学基金会NSF（National Science Foundation）开始建立计算机网络NSFNET。NSFNET成为Internet上主要用于科研和教育的主干部分，代替了ARPANET的骨干地位。

1989年MILNET实现和NSFNET连接后，就开始采用Internet这个名称。自此以后，其他部门的计算机网络相继并入Internet，ARPANET宣告解散。

20世纪90年代初，商业机构开始接入Internet，使Internet开始了商业化的新进程，成为Internet大发展的强大推动力。1995年，NSFNET停止运作，Internet已彻底商业化了。

![05_arpa](http://images.zsjshao.net/rs/01-osi/05_arpa.png)

## 2、OSI参考模型

### 2.1、OSI产生背景

计算机网络市场刚刚兴起的时候，许多计算机生产厂商都积极推出自己公司独创的网络体系架构，像IBM，DEC等，各个公司的网络体系结构各不相同，不同公司之间的网络不能互联互通，导致使用某种网络的用户如果在后继时刻扩展网络则必须继续使用原计算机厂家的设备，而如果换一家计算机，则必须放弃原来的所有设备，因为生产厂商之间的设备不兼容，而且网络相互都是不共享，导致市场上各自保护现象很严重。

因此国际标准化组织（ISO)于1977年设立了专门的机构研究解决上述问题，并于不久后提出了一个是各种计算机都能够互联的标准框架——开放式系统互连参考模型（OSI），简称OSI参考模型。

![06_osi](http://images.zsjshao.net/rs/01-osi/06_osi.png)

### 2.2、OSI参考模型简介

OSI分层：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层

为什么使用分层结构？

- 降低复杂性
- 提高设备的兼容性
- 提供标准化的接口
- 促进模块化工作
- 简化教学和学习
- 易于实现与维护

OSI模型将数据通讯过程分割为7个层次，每个层次都负责各自的功能，并设计了对应的协议实现这些功能，各个层次之间有标准化的接口。

### 2.3、协议数据单元（PDU）

![07_pdu](http://images.zsjshao.net/rs/01-osi/07_pdu.png)

数据通信是由发送方、中间网络设备、接收方共同完成的。

发送方由上而下逐层产生的数据，最终在物理层变成可以在介质上传输的信号，通过网络设备的传输，接收方接收后有一个由下而上逐层上交数据的过程。

这个过程是在发送方、网络设备、接收方的相同层的相同协议之间发生的，我们把相同层相同协议之间协议包的交互叫做对等通信。

每层产生的协议报文有各自的名称，比如传输层叫做段、网络层叫包，数据链路层叫帧，物理层叫比特

### 2.4、OSI参考模型各层次的功能

```
|------------|----------------------------------------------------------------------------------|
| 7 应用层   |提供应用程序间通信                                                                |
|            |  为网络用户之间的通信提供专用的程序                                              |
|            |  为用户提供网络管理、文件传输、事务处理等服务                                    |
|            |  应用层包含的协议最多，也最复杂                                                  |
|------------|----------------------------------------------------------------------------------|
| 6 表示层   |数据表示、加密、解密                                                              |
|            |  向上对应用层提供服务，向下接收会话层服务                                        |
|            |  确保应用接收到的数据可读                                                        |
|            |  规范数据格式与结构                                                              |
|            |  数据压缩和解压、加密和解密                                                      |
|------------|----------------------------------------------------------------------------------|
| 5 会话层   |会话建立维护管理                                                                  |
|            |  会话层不参与具体的传输，它提供包括访问验证和会话管理                            |
|            |  在不同的进程间建立管理维持会话，并能使会话获得同步                              |
|            |  担负应用进程服务要求，而运输层不能完成的那部分工作                              |
|------------|----------------------------------------------------------------------------------|
| 4 传输层   |建立主机端到端连接                                                                |
|            |  处理主机之间的传输问题                                                          |
|            |  确保数据传输的可靠性                                                            |
|            |  建立、维护和终止虚电路                                                          |
|            |  容错机制和流量控制                                                              |
|------------|----------------------------------------------------------------------------------|
| 3 网络层   |寻址和路由                                                                        |
|            |  路由数据包，提供逻辑寻址                                                        |
|            |  基于网络层地址进行不同网络系统间的最优路径选择                                  |
|            |  网络层为建立网络连接和为上层提供服务                                            |
|------------|----------------------------------------------------------------------------------|
|2 数据链路层|介质访问、链路管理                                                                |
|            |  负责将上层数据封装成固定格式的帧                                                |
|            |  为了防止数据传输过程中产生误码，在帧尾部加上校验信息                            |
|            |  还有流控机制 会试探接收方缓存调整速率大小                                       |
|------------|----------------------------------------------------------------------------------|
| 1 物理层   |二进制传输                                                                        |
|            |  定义了电气、机械、形状针脚等物理特性。                                          |
|            |  主要功能是完成相邻节点之间原始比特流的传输，它关心的是如何用物理信号表示0和1    |
|------------|----------------------------------------------------------------------------------|
```

### 2.5、报文封装与解封装

![08_pkg](http://images.zsjshao.net/rs/01-osi/08_pkg.png)

源主机在发送数据之前，沿协议栈自上而下传递应用程序产生的信息。在传递的过程中，每层的协议都会把上层信息加上本协议的头部，组成一个协议数据单元—PDU,我们把这个加协议头部的动作叫做封装。

这个封装的动作是由上而下逐层进行的，也就是说每一层都会把上层的协议包看成一个数据，加上本协议的头部，然后再交给下一层去处理

相对于发送方，接收方对数据的处理有一个相反的过程。

接收方从物理层收到一系列的比特流后，数据链路层按照协议的规则理解为帧，读取数据链路层头部的地址信息和控制信息，如果目标地址是自己能够接收的，就会按照控制信息的规定把头部信息剥离，把剥离后的数据部分传递给网络层，我们把这个剥离协议头部的过程叫做拆封。

对接收方来说，拆封这个动作是由下而上逐层进行的，每层收到下层的数据后，都会读取本协议的头部信息，并把头部信息剥离后交给上层处理。

### 2.6、数据在不同网络设备之间转发

发送方对原始数据进行封装，通过介质发送到下一跳设备

中间的网络设备对数据包进行解封装，查看对应信息，根据表项进行转发

数据经过中转达到目的设备，解封装后到达目标应用程序

![09_forward](http://images.zsjshao.net/rs/01-osi/09_forward.png)

## 3、TCP/IP协议栈

### 3.1、TCP/IP协议栈简介

TCP/IP分层：网络接入层、网络层、传输层、应用层

与OSI模型的区别

- TCP/IP总共定义了4层
- OSI的1、2层合并为网络接入层
- OSI的5、6、7层合并为网络应用层
- OSI模型与TCP/IP模型都是描述网络设备之间通讯标准流程
- TCP/IP模型是Internet的基本协议

![10_tcpip](http://images.zsjshao.net/rs/01-osi/10_tcpip.png)

### 3.2、TCP/IP协议栈

![11_tcpip](http://images.zsjshao.net/rs/01-osi/11_tcpip.png)

#### 3.2.1、应用层

```
为应用程序提供网络服务
  网络应用
    微博、微信、QQ、迅雷……
  
  邮件服务（SMTP、POP3）
    Outlook、新浪邮箱……
  
  网页服务（http、https）
    百度、搜狐、网易
  
  网络管理
    SNMP
  
  远程登录
    Telnet、ssh
  
  地址服务
    DNS、DHCP
```

#### 3.2.2、传输层

```
提供端到端的传输服务
  基于TCP的协议，可靠传输、有重传机制
    FTP、SMTP、Telnet、HTTP

  基于UDP的协议，不可靠传输、效率高
    TFTP、SNMP、DHCP
```

TCP/UDP端口号范围是0~65535，其中0~1023是熟知端口号，已固定分配给常用应用程序

用于在主机系统中区分不同的应用程序，数据传输最终是程序之间的互相访问

- 例1：主机A远程登录主机B，随机端口1028作为源端口，主机B的23端口作为目的端口

- 例2：主机A通过浏览器发起HTTP访问，随机端口作为源端口，主机C的80端口作为目的端口

![12_transport](http://images.zsjshao.net/rs/01-osi/12_transport.png)

##### 3.2.2.1、TCP/UDP 常见协议端口号

![13_port](http://images.zsjshao.net/rs/01-osi/13_port.png)

##### 3.2.2.2、传输层的区别

UDP报文结构简单，传输效率高，但不具备排序功能以及重传机制，数据包到达目的地时，有可能因为网络问题，出现乱序或者丢包现象

- 常用在视频、语音应用等

![14_udp](http://images.zsjshao.net/rs/01-osi/14_udp.png)

TCP报文结构相对复杂，具备序列号、确认号、窗口大小等字段，使其具备排序功能、重传机制、滑动窗口机制，确保数据传输的可靠性，使得数据能够准确按序到达目的地

- 常用在HTTP、FTP等可靠传输

![15_tcp](http://images.zsjshao.net/rs/01-osi/15_tcp.png)

基于TCP协议

- 传输数据前：由TCP建立连接
- 传输过程中：由TCP解决可靠性、有序性，进行流量控制
- 传输结束后：由TCP拆除连接

TCP头部字段

- 端口号：源端口标识发送方的进程，目的端口标识接收方的进程
- 序列号：保证数据传输的有序性，确认号对收到的数据进行确认
- 窗口大小：传输阶段，每次连续发送数据的大小
- Flag字段：
  - ACK：确认号标志，置1表示确认号有效，表示收到对端的特定数据
  - RST：复位标志，置1表示拒绝错误和非法的数据包，复位错误的连接
  - SYN：同步序号标志，置1表示同步序号，用来建立连接
  - FIN：结束标志，置1表示连接将被断开，用于拆除连接

![16_tcp3](http://images.zsjshao.net/rs/01-osi/16_tcp3.png)

###### 3.2.2.2.1、TCP协议工作过程 —— 建立连接 

数据传输之前：三次握手建立连接

Tcp是面向连接的，TCP在传输数据之前必须先建立连接

为建立连接，两台主机的初始序列号ISN必须同步,同步是通过交换三个TCP报文完成的，和正常的tcp报文不同的是，这个TCP报文flag位中的syn置位为1，表示要和对方协商同步ISN，我们把这个过程叫做三次握手建立连接

![17_tcp3](http://images.zsjshao.net/rs/01-osi/17_tcp3.png)

如图所示

1、PC1发送到第一个tcp报文syn置位为1，序列号是由pc1随机厂商的，序列号为A

2、PC2收到pc1发送到报文后，在回应的报文中把ack置位，确认号置位为a+1，表示知晓了pc1的初始序列号，同时把syn置位，把自己的随机序列号b告诉pc1

3、PC1收到报文，在回应的报文中也通过ack的置位和确认号表示知晓了pc2的初始序列号

通过双方交换的这三个报文，完成tcp初始序列号的同步，预留了资源，建立了连接，就可以开始传输数据

建立连接后，所有数据的ack位都会置位

###### 3.2.2.2.2、TCP协议工作过程 —— 数据传输

数据传输过程中，发送方发送窗口大小的数据，接收方只进行一次确认

如果接收方处理能力不足，会调整窗口大小，接收方按新的窗口进行数据发送

![18_window](http://images.zsjshao.net/rs/01-osi/18_window.png)

###### 3.2.2.2.3、TCP协议工作过程 —— 重传机制

当某个包因网络问题，传输失败，接收方仅确认上一个数据包

发送方将根据确认号，进行数据重传

![19_resent](http://images.zsjshao.net/rs/01-osi/19_resent.png)

###### 3.2.2.2.4、TCP协议工作过程 —— 拆除连接

四次挥手拆除连接， TCP通过FIN置位为1表示拆除连接

![20_tcp4](http://images.zsjshao.net/rs/01-osi/20_tcp4.png)

#### 3.2.3、网络层

```
提供主机到主机的传输服务

IP
  提供主机到主机的传输服务

ICMP 
  辅助IP工作，提供出错和控制信息

ARP 
  解析IP与MAC的映射
```

网络层提供主机到主机的传输服务，这种服务是由IP协议提供的,ICMP辅助IP工作，提供出错和控制信息，而ARP协议在以太网中提供IP地址和MAC地址之间的映射。

#### 3.2.4、网络接入层

```
在相邻节点间提供数据传输服务

局域网
  IEEE802.2   定义LLC子层
  IEEE802.3   以太网标准

广域网
  HDLC
  PPP
  Frame Relay

为数据传输提供物理通道

定义接口、线缆标准、传输速率、传输距离等参数

物理层介质
  同轴电缆、双绞线、光纤、无线等
```

每层协议报文都有特定的名称，传输层一般叫做UDP报文或者TCP段，网络层叫做IP包，而数据链路层的协议包一般叫做帧。

数据链路层通过介质在相邻节点间提供数据传输服务

由于存在种类繁多的物理介质，因此在数据链路层定义了不同的数据链路层协议，定义了帧的类型及介质访问方式

在局域网中，IEEE组织通过802.2和802.3定义了一系列协议，而网络中，则定义了HDLC，PPP、帧中继等协议

