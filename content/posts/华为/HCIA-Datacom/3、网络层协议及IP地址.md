## 网络层协议

网络层经常被称为IP层。但网络层协议并不只是IP协议，还包括ICMP（Internet Control Message Protocol)协议、IPX（Internet Packet Exchange）协议等。

### IP协议

• IP是Internet Protocol的缩写。 Internet Protocol本身是一个协议文件的名称，该协议文件的内容非常少，主要是定义并阐述了IP报文的格式。

• 经常被提及的IP，一般不是特指Internet Protocol这个协议文件本身，而是泛指直接或间接与IP协议相关的任何内容。

- 作用：为网络层的设备提供逻辑地址，负责数据包的寻址和转发
- 版本：IPv4 (IP Version 4) 、 IPv6 (IP Version 6)

IP协议有版本之分，分别是IPv4和IPv6。目前，Internet上的IP报文主要都是IPv4报文，但是逐步在向IPv6过渡。

- IPv4（Internet Protocol Version 4）协议族是TCP/IP协议族中最为核心的协议族。它工作在TCP/IP协议栈的网络层，该层与OSI参考模型的网络层相对应。
-  IPv6（Internet Protocol Version 6）是网络层协议的第二代标准协议，也被称为IPng（IP Next Generation）。它是Internet工程任务组IETF（Internet Engineering Task Force）设计的一套规范，是IPv4（Internet Protocol Version 4）的升级版本。

### 数据封装

应用数据需要经过TCP/IP每一层处理之后才能通过网络传输到目的端，每一层上都使用该层的协议数据单元PDU（Protocol Data Unit）彼此交换信息。不同层的PDU中包含有不同的信息，因此PDU在不同层被赋予了不同的名称。

- 如上层数据在传输层添加TCP报头后得到的PDU被称为Segment（数据段）；数据段被传递给网络层，网络层添加IP报头得到的PDU被称为Packet（数据包）；数据包被传递到数据链路层，封装数据链路层报头和尾部得到的PDU被称为Frame（数据帧）；最后，帧被转换为比特，通过网络介质传输。
-  这种协议栈逐层向下传递数据，并添加报头和报尾的过程称为封装。

本章节我们主要讨论数据在网络层的封装，如果封装为IP协议，则被称为IP Packet（IP数据包）。

### IPv4报文格式

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version|  IHL  |Type of Service|          Total Length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Identification        |Flags|      Fragment Offset    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Time to Live |    Protocol   |         Header Checksum       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       Source Address                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Destination Address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

• IP Packet（IP数据包），其包头主要内容如下：

▫ Version：4 bit，4：表示为IPv4；6：表示为IPv6。

▫ Header Length：4 bit，首部长度，如果不带Option字段，则为20，最长为60。

▫ Type of Service：8 bit，服务类型。只有在有QoS差分服务要求时，这个字段才起作用。

▫ Total Length：16 bit，总长度，整个IP数据包的长度。

▫ Identification：16 bit，标识，分片重组时会用到该字段。

▫ Flags：3 bit，标志位。

▫ Fragment Offset：13 bit，片偏移，分片重组时会用到该字段。

▫ Time to Live：8 bit，生存时间。

▫ Protocol：8 bit，协议：下一层协议。指出此数据包携带的数据使用何种协议，以便目的主机的IP层将数据部分上交给哪个进程处理。

▪ 常见值：

− 1: ICMP, Internet Control Message；

− 2: IGMP, Internet Group Management；

− 6: TCP , Transmission Control Protocol；

− 17: UDP, User Datagram Protocol。

▫ Header Checksum：16 bit，首部检验和。

▫ Source IP Address：32 bit，源IP地址。

▫ Destination IP Address：32 bit，目的IP地址。

▫ Options：可变，选项字段。

▫ Padding：可变，填充字段，全填0。

### 数据包分片

将报文分割成多个片段的过程叫做分片。

 网络中转发的IP报文的长度可以不同，但如果报文长度超过了数据链路所支持的最大长度，则报文就需要分割成若干个较小的片段才能够在链路上传输。

  |         Identification        |Flags|      Fragment Offset    |

• Identification：16 bit，发送主机赋予的标识，分片重组时会用到该字段。

• Flags：3 bit，标志位。

​      ▫ 保留段位：0，保留。

​      ▫ 不分段位：1，表示“不能分片”；0，表示“能分片”。

​      ▫ 更多段位：1，表示“后面还有分片”；0，表示“最后一个数据片”。

• Fragment Offset：13 bit，片偏移，分片重组时会用到该字段。指出较长的分组在分片后，该片在原分组中的相对位置，与更多段位组合，帮助接收方组合分段的报文。

### 生存时间 (Time to Live, TTL)

• TTL字段设置了数据包可以经过的路由器数目。

• 一旦经过一个路由器，TTL值就会减1，当该字段值为0时，数据包将被丢弃。

### 协议号 (Protocol)

• IP报文头中的协议号字段标识了将会继续处理该报文的协议。

• 即指出此数据包携带的数据使用何种协议，以便目的主机的IP层将数据部分上报给哪个进程处理。

## IPv4地址介绍

### 什么是IP地址

• IP地址在网络中用于标识一个节点（或者网络设备的接口）。

• IP地址用于IP报文在网络中的寻址。



• 在IP网络上，如果用户要将一台计算机连接到Internet上，就需要申请一个IP地址。IP地址就像现实中的地址，可以标识网络中的一个节点，数据就是通过它来找到目的地的。即我们通过IP地址实现全球范围内的网络通信。

• IP地址是网络设备接口的属性，不是网络设备本身的属性。当我们说给某台设备分配一个IP地址时，实质上是指给这台设备的某个接口分配一个IP地址。如果设备有多个接口，通常每个接口都至少需要一个IP地址。

• 注：需要使用IP地址的接口，通常是路由器和计算机的接口。

### IP地址表示

• 一个IPv4地址有32 bit。

• IPv4地址通常采用“点分十进制”表示。

• IPv4地址范围：0.0.0.0~255.255.255.255。

```
十进制:    192.    168.     10.      1          4 byte
二进制:11000000 10101000 00001010 00000001      32 bit（32位）
```

### IP地址构成

**网络部分：**用来标识一个网络。

**主机部分：**用来区分一个网络内的不同主机。

**网络掩码：**区分一个IP地址中的网络部分及主机部分。

```
192.168.10.1   11000000 10101000 00001010 | 00000001        IP地址
255.255.255.0  11111111 11111111 11111111 | 00000000        网络掩码
                           网络部分        | 主机部分
书写：192.168.10.1 255.255.255.0 = 192.168.10.1/24
```

### IP地址寻址

**网络部分：**用来标识一个网络，代表IP地址所属网络。

**主机部分：**用来区分一个网络内的不同主机，能唯一标识网段上的某台设备。

• 网络号用于表示主机所在的网络，类似于“XX省XX市XX区XX小区”的作用。

• 主机号用于表示网络号所定义的网络范围内某个特定的主机接口，类似于门牌号“XX栋XX号”的作用。

• 网络寻址：

-  二层网络寻址：可直接通过IP地址，找到对应的主机接口。
-  三层网络寻址：利用网关转发来自不同网段之间的数据包。

网关：

▫ 报文转发过程中，首先需要确定转发路径以及通往目的网段的接口。如果目的主机与源主机不在同一网段，报文需要先转发到网关，然后通过网关将报文转发到目的网段。

▫ 网关是指接收并处理本地网段主机发送的报文并转发到目的网段的设备。为实现此功能，网关必须知道目的网段的路由。网关设备上连接本地网段的接口地址即为该网段的网关地址。

### IP地址分类 (有类编址)

 为了方便IP地址的管理及组网，IP地址分成五类：

**A类**：0.0.0.0~127.255.255.255      ，0          ，分配主机使用

**B类**：128.0.0.0~191.255.255.255 ，10        ，分配主机使用

**C类**：192.0.0.0~223.255.255.255 ，110      ，分配主机使用

**D类**：224.0.0.0~239.255.255.255 ，1110   ，组播

**E类**：240.0.0.0~255.255.255.255 ， 1111   ，研究

A/B/C类默认网络掩码

▫ A类：8 bit， 0.0.0.0~127.255.255.255/8

▫ B类：16 bit，128.0.0.0~191.255.255.255/16

▫ C类：24 bit，192.0.0.0~223.255.255.255/24

### IP地址类型

我们通常把一个网络号所定义的网络范围称为一个网段。

**网络地址：**用于标识一个网络。

**广播地址**：用于向该网络中的所有主机发送数据的特殊地址。

**可用地址**：又称主机地址，可分配给网络中的节点或网络设备接口的地址。

**注意**

- 网络地址和广播地址不能直接被节点或网络设备所使用。
- 一个网段可用地址数量为：2ⁿ-2（n：主机部分的比特位数）

### IP地址计算

• 网络地址：将IP地址的主机位全设为0，所得结果是该IP地址所在网络的网络地址。

• 广播地址：将IP地址的主机位全设为1，所得结果是该IP地址所在网络的广播地址。

• IP地址数：2ⁿ，n为主机位位数。

• 可用IP地址数：2ⁿ-2，n为主机位位数。

### 私网IP地址

• **公网IP地址：**IP地址是由IANA统一分配的，以保证任何一个IP地址在Internet上的唯一性。这里的IP地址是指公网IP地址。

• **私网IP地址：**实际上一些网络不需要连接到Internet，比如一个大学的封闭实验室内的网络，只要同一网络中的网络设备的IP地址不冲突即可。在IP地址空间里，A、B、C三类地址中各预留了一些地址专门用于上述情况，称为私网IP地址。

▫ A类：10.0.0.0~10.255.255.255

▫ B类：172.16.0.0~172.31.255.255

▫ C类：192.168.0.0~192.168.255.255

私有网络连接到Internet：私有网络由于使用了私网IP地址，是不允许连接到Internet的。后来在实际需求的驱动下，许多私有网络也希望能够连接到Internet上，从而实现私网与Internet之间的通信，以及通过Internet实现私网与私网之间的通信。私网与Internet的互联，必须使用网络地址转换 (NAT)技术实现。

▫ NAT (Network Address Translation)，网络地址转换，其基本作用是实现私网IP地址与公网IP地址之间的转换。

▫ IANA (Internet Assigned Numbers Authority)，因特网地址分配组织。

### 特殊IP地址

IP地址空间中，有一些特殊的IP地址，这些IP地址有特殊的含义和作用，举例如下。

|特殊IP地址 |地址范围| 作用|
|-|-|-|
|有限广播地址 |255.255.255.255 可作为目的地址，发往该网段所有主机（受限于网关）|
|任意地址| 0.0.0.0 “任何网络”的网络地址；“这个网络上这个主机接口”的IP地址|
|环回地址 |127.0.0.0/8 测试设备自身的软件系统|
|本地链路地址 |169.254.0.0/24 当主机自动获取地址失败后，可使用该网段中的某个地址进行临时通信|

### IPv4 vs IPv6

 由全球IP地址分配机构，IANA (Internet Assigned Numbers Authority)管理的IPv4地址，于2011年完全用尽。随着最后一个IPv4公网地址分配完毕，加上接入公网的用户及设备越来越多，IPv4地址枯竭的问题日益严重，这是当前IPv6替代IPv4的最大源动力。

**IPv4** 

• 地址长度：32 bit

• 地址分类：单播地址、广播地址、组播地址

• 特点：

- 地址枯竭
- 包头设计不合理
- 对ARP的依赖，导致广播泛滥
- ……

**IPv6**

• 地址长度：128 bit

• 地址分类：单播地址、组播地址、任播地址

• 特点：

- 无限地址
- 简化的报文头部
- IPv6地址自动部署
- ……

## 子网划分

### 为什么要划分子网

“有类编址”的地址划分过于死板，划分的颗粒度太大，会有大量的主机号不能被充分利用，从而造成了大量的IP地址资源浪费。

- 一个B类地址用于一个广播域，地址浪费。
- 广播域太庞大，一旦发生广播，内网不堪重负。

因此可以利用子网划分来减少地址浪费，即VLSM (Variable Length Subnet Mask)，可变长子网掩码。将一个大的有类网络，划分成若干个小的子网，使得IP地址的使用更为科学。

- 将一个网络号划分成多个子网，每个子网分配给一个独立的广播域。
- 如此一来广播域的规模更小、网络规划更加合理。
- IP地址得到了合理利用。

### 如何进行子网划分 - 原网段分析

• 假设有一个C类网段地址：192.168.10.0；默认情况下，网络掩码为24位，包括24位网络位，8位主机位。

• 通过计算可知，这样的网络中，有256个IP地址。

### 如何进行子网划分 - 向主机借位

向主机借位，形成子网。

- 现在，将原有的24位网络位向主机位去“借”1位，这样网络位就扩充到了25位，相对的主机位就减少到了7位，而借过来的这1位就是子网位，此时网络掩码就变成了25位，即255.255.255.128，或/25。
- 子网位：可取值0或取值1，则得到了两个新的子网。
- 通过计算可知，现在网络中，有128个IP地址。

可变长子网掩码，VLSM (Variable Length Subnet Mask)

### 如何进行子网划分 - 计算子网网络地址

计算网络地址，主机位全为0：

▫ 如果子网位取值0，则网络地址为192.168.10.0。

▫ 如果子网位取值1，则网络地址为192.168.10.128。

### 如何进行子网划分 - 计算子网广播地址

计算广播地址，主机位全为1：

▫ 如果子网位取值0，则广播地址为192.168.10.127。

▫ 如果子网位取值1，则广播地址为192.168.10.255。

## ICMP协议

### ICMP协议

Internet控制消息协议ICMP (Internet Control Message Protocol)是IP协议的辅助协议。

ICMP协议用来在网络设备间传递各种差错和控制信息，对于收集各种网络信息、诊断和排除各种网络故障等方面起着至关重要的作用。

```
+0------7-------15---------------31
|  Type | Code  |    Checksum    |
+--------------------------------+
|          Message Body          |
|        (Variable length)       |
+--------------------------------+
```

|Type| Code |描述|
|-|-|-|
|0| 0| Echo Reply|
|3| 0| 网络不可达|
|3| 1| 主机不可达|
|3| 2| 协议不可达|
|3|3| 端口不可达|
|5| 0| 重定向|
|8| 0| Echo Request|

为了更有效地转发IP数据报文和提高数据报文交互成功的机会，在网络层使用ICMP协议。ICMP允许主机或设备报告差错情况和提供有关异常情况的报告。

• ICMP消息：

- ICMP消息封装在IP报文中，IP报文头部Protocol值为1时表示ICMP协议。
- 字段解释：
  - ICMP消息的格式取决于Type和Code字段，其中Type字段为消息类型，Code字段包含该消息类型的具体参数。
  - 校验和字段用于检查消息是否完整。
  - 消息中包含32 bit的可变参数，这个字段一般不使用，通常设置为0。
    - 在ICMP重定向消息中，这个字段用来指定网关IP地址，主机根据这个地址将报文重定向到指定网关。
    - 在Echo请求消息中，这个字段包含标识符和序号，源端根据这两个参数将收到的回复消息与本端发送的Echo请求消息进行关联。尤其是当源端向目的端发送了多个Echo请求消息时，需要根据标识符和序号将Echo请求和回复消息进行一一对应。

### ICMP重定向

ICMP重定向报文是ICMP控制报文中的一种。在特定的情况下，当路由器检测到一台机器使用非最优路由的时候，它会向该主机发送一个ICMP重定向报文，请求主机改变路由。

### ICMP差错检测

ICMP Echo消息常用于诊断源和目的地之间的网络连通性，同时还可以提供其他信息，如报文往返时间等。

ICMP的一个典型应用是Ping。Ping是检测网络连通性的常用工具，同时也能够收集其他相关信息。用户可以在Ping命令中指定不同参数，如ICMP报文长度、发送的ICMP报文个数、等待回复响应的超时时间等，设备根据配置的参数来构造并发送ICMP报文，进行Ping测试。

### ICMP错误报告

ICMP定义了各种错误消息，用于诊断网络连接性问题；根据这些错误消息，源设备可以判断出数据传输失败的原因。如：当网络设备无法访问目标网络时，会自动发送ICMP目的不可达报文到发送端设备。

• ICMP定义了各种错误消息，用于诊断网络连接性问题；根据这些错误消息，源设备可以判断出数据传输失败的原因。

- 如果网络中发生了环路，导致报文在网络中循环，且最终TTL超时，这种情况下网络设备会发送TTL超时消息给发送端设备。
- 如果目的地不可达，则中间的网络设备会发送目的不可达消息给发送端设备。目的不可达的情况有多种，如果是网络设备无法找到目的网络，则发送目的网络不可达消息；如果网络设备无法找到目的网络中的目的主机，则发送目的主机不可达消息。

• ICMP的另一个典型应用是Tracert。Tracert基于报文头中的TTL值来逐跳跟踪报文的转发路径。为了跟踪到达某特定目的地址的路径，源端首先将报文的TTL值设置为1。该报文到达第一个节点后，TTL超时，于是该节点向源端发送TTL超时消息，消息中携带时间戳。然后源端将报文的TTL值设置为2，报文到达第二个节点后超时，该节点同样返回TTL超时消息，以此类推，直到报文到达目的地。这样，源端根据返回的报文中的信息可以跟踪到报文经过的每一个节点，并根据时间戳信息计算往返时间。

## IPv4地址配置及基本应用

### IP地址的基础配置命令

1.进入接口视图

```
[Huawei] interface interface-type interface-number
```

通过此命令可以进入指定的接口视图，配置接口的相关属性。

• *interface-type interface-number*：指定接口类型和接口编号。接口类型和接口编号之间可以输入空格也可以不输入空格。

2.配置接口的IP地址

```
[Huawei-GigabitEthernet0/0/1] ip address ip-address { mask | mask-length }
```

在接口视图下，通过此命令来给网络设备上的接口配置IP地址，实现网络的互连。

• *ip-address*：指定接口的IP地址，点分十进制形式。

• *mask*：指定子网掩码，点分十进制形式。

• *mask-length*：指定掩码长度，整数形式，取值范围是0～32。

**配置物理接口地址：**

```
[RTA] interface gigabitethernet 0/0/1
[RTA-GigabitEthernet0/0/1] ip address 192.168.1.1 255.255.255.0
或
[RTA-GigabitEthernet0/0/1] ip address 192.168.1.1 24
```

**配置逻辑接口地址：**

```
[RTA] interface LoopBack 0
[RTA-LoopBack0] ip address 1.1.1.1 255.255.255.255
或
[RTA-LoopBack0] ip address 1.1.1.1 32
```

### 网络IP地址规划

• IP地址规划要和网络结构、路由协议、流量规划、业务规则等结合起来考虑。IP地址的规划应尽可能和网络层次相对应，应该是自顶向下的一种规划。

• 总得来说： IP地址规划的目标是：易管理、易扩展、利用率高。

• 规划原则：

- 唯一性：一个IP网络中不能有两个主机采用相同的IP地址。
- 连续性：连续地址在层次结构网络中易于进行路由汇总，大大缩减路由表，提高路由计算的效率、加速路由收敛。
- 扩展性：地址分配在每一层次上都要有合理的预留，在网络规模扩展时能保证路由汇总所需的连续性。避免网络扩展造成的地址、路由重新规划。
- 结构化、业务相关性：地址规划与网络拓扑结构和网络承载业务结合起来，便于路由规划和QoS部署。好的IP地址规划使得每个地址都具有实际含义，看到一个地址就可以大致判断出该地址所属的设备和对应的业务。



**思考题**

1.（单选）201.222.5.64是第几类IP地址。( )

A. A类

B. B类

C. C类

D. D类

2.（多选）某公司被分到了一个C类网络地址段192.168.20.0/24，现有一个部门有40台主机，请问以下哪些子网可被分配( )？

A. 192.168.20.64/26

B. 192.168.20.64/27

C. 192.168.20.128/26

D. 192.168.20.190/26

1.C  2.AC
