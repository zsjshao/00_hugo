## 路由概述

### 路由基本概念

#### 背景：网段间通信

• IP地址唯一标识了网络中的一个节点，每个IP地址都拥有自己的网段，各个网段可能分布在网络的不同区域。

• 为实现IP寻址，分布在不同区域的网段之间要能够相互通信。

```
                                 |---------|
                                 |    R    | ---- 《M》
                                 |---------| \
                                      |        \
                                      |          \
                                      |            \
                                      |              \
                                      |                \ 
                                      |                  \
       |---------|               |---------|               |---------|
    ---|    R    |---------------|    R    |---------------|    R    |-----
       |---------|              /|---------| \            /|---------|
            |                 /       |        \        /       |
            |               /         |          \    /         |
            |             /           |            \/           |
            |           /             |           /  \          |
            |         /               |         /      \        |
            |       /                 |       /          \      |
       |---------|/              |---------|/              |---------|
《N》---|    R    |---------------|    R    |---------------|    R    |-----
       |---------|               |---------|               |---------|
            ↓
        如何前往网络M？
```

#### 路由

• 路由是指导报文转发的路径信息，通过路由可以确认转发IP报文的路径。

• 路由设备是依据路由转发报文到目的网段的网络设备，最常见的路由设备：路由器。

• 路由设备维护着一张路由表，保存着路由信息。

```
     路由设备                      |---------|
                                 |   R4    |
                                 |---------| \
                                      |        \
                                      |          \
                                      |            \
                                      |              \
                                      |                \
DATA                                  |                  \
  ——>  |---------|   -->         |---------|  -->          |---------| -->
《N》 --|   R1    |---------------|   R2    |---------------|   R3    |--- 《M》
       |---------|               |---------|               |---------|
            ↓                         ↓                         ↓
           -------------------------------------------------------             
           |                    依据路由转发                        |
           -------------------------------------------------------
```

• 网关以及中间节点（路由器）根据收到的IP报文其目的地址选择一条合适的路径，并将报文转发到下一个路由器。在路径中的最后一跳路由器二层寻址将报文转发给目的主机。这个过程被称为路由转发。

• 中间节点选择路径所依赖的表项为称为路由表。

• 路由条目包含明确的出接口以及下一跳，这两项信息指导IP报文转发到相应的下一跳设备上。

#### 路由信息介绍

```
                            1.1.1.2  |---------|
                         |-----------|    R    |--- 10.1.1.0/24
                         |           |---------|
|---------|              |
|    R    |--------------|
|---------|GE0/0/0       |
                         |  1.1.1.3  |---------|
                         |-----------|    R    |
                                     |---------|
```

IP路由

|目的网络/掩码 |出接口| 下一跳|
|-|-|-|
|10.1.1.0/24| GE0/0/0| 1.1.1.2|

路由中包含以下信息：

▫ 目的网络：标识目的网段

▫ 掩码：与目的地址共同标识一个网段

▫ 出接口：数据包被路由后离开本路由器的接口

▫ 下一跳：路由器转发到达目的网段的数据包所使用的下一跳地址

这些信息标识了目的网段、明确了转发IP报文的路径。

只有出接口并不能够确认转发IP报文的下一跳设备，还需要明确的下一跳设备地址。

#### 路由表

```
                                 14.0.0.0/8
                                 |---------|
                                 |   R4    | 
                                 |---------|
                                      | 1.1.1.2/30
                                      |
                                      |
                                      |
                                      | GE0/2
                                      | 1.1.1.1/30
                                 |---------|
                                 |   R2    |
                         GE0/0  /|---------| \ GE0/1
                   2.2.2.1/30 /                \ 3.3.3.1/30
                            /                    \
                          /                        \
                        /                            \
                      /                                \
         2.2.2.2/30 /                                    \ 3.3.3.2/30
       |---------|                                         |---------|
《N》---|   R1    |                                         |   R3    |-----
       |---------|                                         |---------|
       11.0.0.0/8                                          13.0.0.0/8
```
R2的路由表


|目的网络/掩码| 下一跳| 出接口|
|-|-|-|
|11.0.0.0/8 |2.2.2.2| GE0/0|
|13.0.0.0/8| 3.3.3.2| GE0/1|
|14.0.0.0/8| 1.1.1.2| GE0/2|
|………..|
|1.1.1.0/30| 1.1.1.1| GE0/2|
|1.1.1.1/32| 127.0.0.1|GE0/2|

• 路由器通过各种方式发现路由

• 路由器选择最优的路由条目放入路由表中

• 路由表指导设备对IP报文的转发

• 路由器通过对路由表的管理实现对路径信息的管理

### 路由条目生成

#### 路由信息获取方式

路由器依据路由表进行路由转发，为实现路由转发，路由器需要发现路由，以下为常见的路由获取方式。

• 直连路由：直连接口所在网段的路由，由设备自动生成。

• 静态路由：由网络管理员手工配置的路由条目

• 动态路由：路由器通过动态路由协议（如OSPF、IS-IS、BGP等）学习到的路由

#### 直连路由

```
                 GE0/0/0       
             10.0.0.2/24 |---------|
10.0.0.0/24 -------------|   RTB   |----------- 20.1.1.0/24
                         |---------| GE0/0/1
                                     20.1.1.2/24
```

RTB路由表中的直连路由

|目的网络| 来源| 下一跳| 出接口|
|-|-|-|-|
|10.0.0.0/24| 直连 |10.0.0.2| GE0/0/0|
|20.1.1.0/24| 直连 |20.1.1.2| GE0/0/1|

• 直连路由指向本地直连网络的路由，由设备自动生成。

• 当路由器为路由转发的最后一跳路由器时，IP报文匹配直连路由，路由器转发IP报文到目的主机。

• 使用直连路由进行路由转发时，报文的目的IP和路由器接口IP在一个网段之中。

```
                 GE0/0/0       
             10.0.0.2/24 |---------|
10.0.0.0/24 ---------断开-|   RTB   |----------- 20.1.1.0/24
                         |---------| GE0/0/1
                                     20.1.1.2/24
```

RTB路由表中的直连路由

| 目的网络    | 来源 | 下一跳   | 出接口  |
| ----------- | ---- | -------- | ------- |
| 20.1.1.0/24 | 直连 | 20.1.1.2 | GE0/0/1 |

• 并不是所有接口生成的直连路由都会出现在路由表中，直连路由出现在路由表中的前提是该接口的物理状态、协议状态都为UP。

• 使用直连路由进行路由转发时，转发的动作不是交给下一跳，而是查询ARP表项，根据ARP表项封装报文，将报文发送到目的IP。

### 最优路由条目优选

#### 查看IP路由表

```
<Huawei> display ip routing-table
Route Flags: R - relay, D - download to fib
-----------------------------------------------------------------------------------------------
Routing Tables: Public
Destinations : 6 Routes : 6
Destination/Mask Proto  Pre Cost Flags NextHop   Interface
1.1.1.1/32       Static 60  0    D     0.0.0.0   NULL0
2.2.2.2/32       Static 60  0    D     100.0.0.2 Vlanif100
100.0.0.0/24     Direct 0   0    D     100.0.0.1 Vlanif100
100.0.0.1/32     Direct 0   0    D     127.0.0.1 Vlanif100
127.0.0.0/8      Direct 0   0    D     127.0.0.1 InLoopBack0
127.0.0.1/32     Direct 0   0    D     127.0.0.1 InLoopBack0
目的网络地址/      协议类型 路由优先级 标志   下一跳地址  出接口
网络掩码长度                  开销（度量值）
```

#### 路由表中各个内容的含义

• Destination/Mask：表示此路由的目的网络地址与网络掩码。将目的地址和子网掩码“逻辑与”后可得到目的主机或路由器所在网段的地址。例如：目的地址为1.1.1.1，掩码为255.255.255.0的主机或路由器所在网段的地址为1.1.1.0。

• Proto（Protocol）：该路由的协议类型，也即路由器是通过什么协议获知该路由的。

• Pre（Preference）：表示此路由的路由协议优先级。针对同一目的地，可能存在不同下一跳、出接口等多条路由，这些不同的路由可能是由不同的路由协议发现的，也可以是手工配置的静态路由。优先级最高（数值最小）者将成为当前的最优路由。

• Cost：路由开销。当到达同一目的地的多条路由具有相同的路由优先级时，路由开销最小的将成为当前的最优路由。

• NextHop：表示对于本路由器而言，到达该路由指向的目的网络的下一跳地址。该字段指明了数据转发的下一个设备。

• Interface：表示此路由的出接口。指明数据将从本路由器的哪个接口转发出去。



Preference用于不同路由协议间路由优先级的比较，Cost用于同一种路由协议内部不同路由的优先级的比较。在业界，Cost也被称为路由度量值（Metric）。

#### 路由优先级

优先级比较

```
  路由条目
    |
    |
    ↓        不同
  网段/掩码-----------> 加入路由表 <---
    |                             |
相同 |                             |
    ↓      优先级高                 |
  优先级 ---------------------------
```

• 当路由器从多种不同的途径获知到达同一个目的网段的路由（这些路由的目的网络地址及网络掩码均相同）时，路由器会比较这些路由的优先级，优选优先级值最小的路由。

• 路由来源的优先级值（Preference）越小代表加入路由表的优先级越高。

• 拥有最高优先级的路由将被添加进路由表。

|目的网络/掩码 |来源| 优先级| 下一跳|
|--|--|--|--|
|10.0.0.0/30 |静态 |60 |30.1.1.2|
|10.0.0.0/30 |OSPF |10 |20.1.1.2   <-----加入路由表|

• 每一种路由协议都有相应的优先级。

• OSPF拥有更优的优先级，因此通过OSPF学习到的路由被添加到路由表中。

##### 路由优先级 - 常见默认数值

|路由来源 |路由类型 |默认优先级|
|--|--|--|
|直连 |直连路由|0|
|静态| 静态路由 |60|
|动态路由|OSPF内部路由<br />OSPF外部路由| 10<br />150 |

#### 度量值

```
          路由条目
            |
            |
            ↓        不同
          网段/掩码-----------> 加入路由表 <--
            |                             |
        相同 |                             |
            ↓      优先级高                 |
          优先级 --------------------------|
            |                             | 
   优先级相等 |                             |
            ↓       度量值小               |
          度量值---------------------------
```



• 当路由器通过某种路由协议发现了多条到达同一个目的网络的路由时（拥有相同的路由优先级），度量值将作为路由优选的依据之一。

• 路由度量值表示到达这条路由所指目的地址的代价。

• 一些常用的度量值有：跳数、带宽、时延、代价、负载、可靠性等。

• 度量值数值越小越优先，度量值最小路由将会被添加到路由表中。

• 度量值很多时候被称为开销（Cost）。

|目的网络/掩码 |来源 |Cost| 下一跳|
|--|--|--|--|
|10.0.0.0/30 |OSPF| 20| 20.1.1.2|
|10.0.0.0/30| OSPF| 10 |30.1.1.2    <-----加入路由表|

### 路由转发

#### 最长匹配原则

当路由器收到一个IP数据包时，会将数据包的目的IP地址与自己本地路由表中的所有路由表项进行逐位（Bit-By-Bit）比对，直到找到匹配度最长的条目，这就是最长前缀匹配机制。

#### 路由转发流程

```
PC<--->网关(R1)<--->R2<--->网关(R3)<--->PC
```

• 当路由器收到一个数据包时，会在自己的路由表中查询数据包的目的IP地址。如果能够找到匹配的路由表项，则依据表项所指示的出接口及下一跳来转发数据；如果没有匹配的表项，则丢弃该数据包。

• 路由器的行为是逐跳的，数据包从源到目的地沿路径每个路由器都必须有关于目标网段的路由，否则就会造成丢包。

• 数据通信往往是双向的，因此要关注流量的往返（往返路由）。

## 静态路由

• 静态路由由网络管理员手动配置，配置方便，对系统要求低，适用于拓扑结构简单并且稳定的小型网络。

• 缺点是不能自动适应网络拓扑的变化，需要人工干预。

### 静态路由配置

关联下一跳IP的方式

```
[Huawei] ip route-static ip-address { mask | mask-length } nexthop-address
```

关联出接口的方式

```
[Huawei] ip route-static ip-address { mask | mask-length } interface-type interface-number
```

关联出接口和下一跳IP方式

```
[Huawei] ip route-static ip-address { mask | mask-length } interface-type interface-number [nexthop-address]
```

在创建静态路由时，可以同时指定出接口和下一跳。对于不同的出接口类型，也可以只指定出接口或只指定下一跳。
对于点到点接口（如串口），只需指定出接口。
对于广播接口（如以太网接口）和VT（Virtual-template）接口，必须指定下一跳。

示例

```
                       GE0/0/0                      S1/0/0
   |---------|     10.0.0.2/24 |---------|     20.1.1.3/24 |---------|
   |   RTA   |-----------------|   RTB   |-----------------|   RTC   |
   |---------| GE0/0/0         |---------| S1/0/0          |---------|
               10.0.0.1/24                 20.1.1.2/24
               
               ---->                                 <----
               前往20.1.1.0/24                       前往10.1.1.0/24
```



```
[RTA] ip route-static 20.1.1.0 255.255.255.0 10.0.0.2

[RTC] ip route-static 10.0.0.0 255.255.255.0 S1/0/0
```

注意：通信是双向的，需要配置往返路由

### 缺省路由

• 缺省路由是一种特殊的路由，当报文没有在路由表中找到匹配的具体路由表项时才使用的路由。如果报文的目的地址不能与路由表的任何目的地址相匹配，那么该报文将选取缺省路由进行转发。

• 缺省路由在路由表中的形式为0.0.0.0/0，缺省路由也被叫做默认路由。

```
                       GE0/0/0                      | 192.168.1.0/24
   |---------|     10.0.0.2/24 |---------|          | 192.168.2.0/24
   |   RTA   |-----------------|   RTB   |----------| 192.168.3.0/24
   |---------| GE0/0/0         |---------|          |       ..
               10.0.0.1/24                          | 192.168.254.0/24
```

RTA前往非本地直连网段，将报文转发给10.0.0.2

```
[RTA] ip route-static 0.0.0.0 0 10.0.0.2
```

缺省路由一般用于企业网络指向出口，配置一条缺省路由让设备能够转发前往Internet上任意地址的IP报文。

## 动态路由

### 动态路由概述

• 静态路由的缺点是不能自动适应网络拓扑的变化，需要人工干预。

• 动态路由协议有自己的路由算法，能够自动适应网络拓扑的变化，适用于具有一定数量三层设备的网络。

### 动态路由分类

按工作区域分类

- IGP（Interior Gateway Protocols，内部网关协议）
  - RIP  OSPF  IS-IS

- EGP（Exterior Gateway Protocols，外部网关协议）
  - BGP

按工作机制及算法分类

- （Distance Vector Routing Protocols，距离矢量路由协议）
  - RIP
- （Link-State Routing Protocols，链路状态路由协议）
  - OSPF  IS-IS 

BGP使用一种基于距离矢量算法修改后的算法，该算法被称为路径矢量（Path Vector）算法。因此在某些场合下，BGP也被称为路径矢量路由协议。

## 路由高级特性

### 路由递归

• 路由必须有直连的下一跳才能够指导转发，但是路由生成时下一跳可能不是直连的，因此需要计算出一个直连的下一跳和对应的出接口，这个过程就叫做路由递归。

• 路由递归也被称为路由迭代。

```
                       GE0/0/0                      S1/0/0
   |---------|     10.0.0.2/24 |---------|     20.1.1.3/24 |---------|
   |   RTA   |-----------------|   RTB   |-----------------|   RTC   |------ 30.1.2.0/24
   |---------| GE0/0/0         |---------| S1/0/0          |---------|
               10.0.0.1/24                 20.1.1.2/24

[RTA] ip route-static 30.1.2.0 24 20.1.1.3
去往30.1.2.0/24的路由，下一跳为20.1.1.3，非本地直连网络，如果路由表中没有去往20.1.1.3的路由，该静态路由将不会生效，无法作为有效路由条目，并不会出现在路由表。

[RTA] ip route-static 30.1.2.0 24 20.1.1.3
[RTA] ip route-static 20.1.1.0 24 10.0.0.2
添加一条去往20.1.1.3的路由，下一跳为直连网络内的IP地址10.0.0.2.
去往30.1.2.0/24的路由通告递归查询得到一个直连的下一跳，该路由因此生效。
```

### 等价路由

```
                  GE0/0/0                      GE0/0/0
   |------------| 20.1.1.1/30    Cost=10   20.1.1.2/30 |------------| 
   |            |--------------------------------------|            |
   |    RTA     |                                      |    RTB     |-----10.0.0.0/30
   |            |--------------------------------------|            |
   |------------| GE0/0/1        Cost=10       GE0/0/1 |------------|
                  30.1.1.1/30              30.1.1.2/30   
```

RTA路由表

| 目的网络/掩码 | 下一跳   |
| ------------- | -------- |
| 10.0.0.0/30   | 20.1.1.2 |
|               | 30.1.1.2 |

路由表中存在等价路由之后，前往该目的网段的IP报文路由器会通过所有有效的接口、下一跳转发，这种转发行为被称为负载分担。

### 浮动路由

• 静态路由支持配置时手动指定优先级，可以通过配置目的地址/掩码相同、优先级不同、下一跳不同的静态路由，实现转发路径的备份。

• 浮动路由是主用路由的备份，保证链路故障时提供备份路由。主用路由下一跳可达时该备份路由不会出现在路由表。

```
[RTA] ip route-static 20.0.0.0 30 10.1.1.2
[RTA] ip route-static 20.0.0.0 30 10.1.2.2 preference 70
```

### CIDR

• CIDR（classless inter-domain routing，无类别域间路由）采用IP地址加掩码长度来标识网络和子网，而不是按照传统A、B、C等类型对网络地址进行划分。

• CIDR容许任意长度的掩码长度，将IP地址看成连续的地址空间，可以使用任意长度的前缀分配，多个连续的前缀可以聚合成一个网络，该特性可以有效减少路由表条目数量。

### 路由汇总

• 子网划分、VLSM解决了地址空间浪费的问题，但同时也带了新的问题：路由表中的路由条目数量增加。

• 为减少路由条目数量可以使用路由汇总。

```
                       GE0/0/0                      | 10.1.1.0/24
   |---------|     12.1.1.2/30 |---------|          | 10.1.2.0/24
   |   RTA   |-----------------|   RTB   |----------|     ...
   |---------| GE0/0/0         |---------|          |     ...
               12.1.1.1/30                          | 10.1.10.0/24
               
 [RTA] ip route-static 10.1.0.0 16 12.1.1.2
```

• 路由汇总将一组具有相同前缀的路由汇聚成一条路由，从而达到减小路由表规模以及优化设备资源利用率的目的。

• 路由汇总采用了CIDR的思想：将相同前缀的地址聚合成一个。

• 我们把汇聚之前的这组路由称为精细路由或明细路由，把汇聚之后的这条路由称为汇总路由或聚合路由。

#### 汇总计算

• 基于一系列连续的、有规律的IP网段，如果需计算相应的汇总路由，且确保得出的汇总路由刚好“囊括”上述IP网段，则需保证汇总路由的掩码长度尽可能长。

• 诀窍在于：将明细路由的目的网络地址都换算成二进制，然后排列起来，找出所有目的网络地址中“相同的比特位”。

#### 汇总引发的问题

路由汇总带来的环路问题

• 一般来说一条路由，无论是静态的或者是动态的，都需要关联到一个出接口，路由的出接口指的是设备要到达一个目的网络时的出站接口。路由的出接口可以是该设备的物理接口，例如百兆、千兆以太网接口，也可以是逻辑接口，例如VLAN接口（VLAN Interface），或者隧道（Tunnel）接口等。在众多类型的出接口中，有一种接口非常特殊，那就是Null（无效）接口，这种类型的接口只有一个编号，也就是0。Null0是一个系统保留的逻辑接口，当网络设备在转发某些数据包时，如果使用出接口为Null0的路由，那么这些报文将被直接丢弃，就像被扔进了一个黑洞里，因此出接口为Null0的路由又被称为黑洞路由。

```
[RTB] ip route-static 10.1.0.0 16 0 NULL0
```

#### 精确汇总

往往无法实现精确汇总，保持明细
