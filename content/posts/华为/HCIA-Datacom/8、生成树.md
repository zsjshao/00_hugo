## 生成树技术概述

### 冗余和环路

随着局域网规模的不断扩大，越来越多的交换机被用来实现主机之间的互连。接入层交换机单链路上联，则存在单链路故障，也就是如果这根上联链路发生故障，交换机下联用户就断网了。另一个问题的单点故障，也就是交换机如果宕机，交换机下联用户也就断网了。

为了解决此类问题，交换机在互连时一般都会使用冗余链路来实现备份。冗余链路虽然增强了网络的可靠性，但是也会产生环路，而环路会带来一系列的问题，继而导致通信质军下降和通信业务中断等问题。

在现实中，除了冗余链路会引起环路，还有一些人为错误导致的环路。

### 二层环路带来的问题

问题一:广播风暴

- 根据交换机的转发原则，如果交换机从一个端口上接收到的是一个广播帧，或者是一个目的MAC地址未知的单播帧，则会将这个帧向除源端口之外的所有其他端口转发。如果交换网络中有环路，则这个帧会被无限转发，此时便会形成广播风暴，网络中也会充斥着重复的数据帧。

问题二:MAC地址表漂移

- 交换机是根据所接收到的数据帧的源地址和接收端口生成MAC地址表项的

- 从不同接口来回收到相同MAC的数据帧，导致MAC地址在接口来回切换，这被称为MAC地址漂移现象。

### 初识生成树协议

在以太网中，二层网络的环路会带来广播风暴，MAC地址表震荡，重复数据帧等问题，为解决交换网络中的环路问题，提出了STP。

STP通过构造一棵树来消除交换网络中的环路

运行STP算法，判断网络中存在环路的地方并阻断冗余链路，将环路网络修剪成无环路的树型网络，从而避免了数据帧在环路网络中的增生和无穷循环。



交换机上运行的生成树协议会持续监控网络的拓扑结构，当网络拓扑结构发生变化时，生成树能感知到这些变化，并且自动做出调整。

因此，生成树既能解决二层环路问题，也能为网络的几余性提供一种方案。

### 二层及三层环路

常见环路主要分为二层环路和三层环路。

- 二层环路主要因为网络中部署了二层冗余环境，或人为的误接线缆导致，可以通过借助特定的协议或机制实现二层防环;
- 三层环路主要因为路由环路，可以通过动态路由协议防环和IP报文头部中的TTL字段用于防止报文被无止尽地转发。



生成树协议应用于园区网络的二层网络中，进行链路备份和消除环路。

### STP概述

STP是一个用于局域网中消除环路的协议。

运行该协议的设备通过彼此交互信息而发现网络中的环路，并对某些接口进行阻塞以消除环路。

STP在网络中运行后会持续监控网络的状态，当网络出现拓扑变更时，STP能够感知并且进行自动响应，从而使得网络状态适应新的拓扑结构，保证网络可靠性。

由于局域网规模的不断增长，生成树协议已经成为了当前最重要的局域网协议之一

## STP的基本概念及工作原理

### 桥ID(Bridge lD，BlD)

IEEE 802.1D标准中规定BID由16位的桥优先级(Bridge Priority)与桥MAC地址构成。

每一台运行STP的交换机都拥有一个唯一的BID。

BID桥优先级占据高16bit，其余的低48bit是桥MAC地址。

在STP网络中，BD最小的设备会被选举为根桥。

备注:此处网桥(Bridge)，或者桥也就是交换机。

### 根桥(Root Bridge）


STP的主要作用之一是在整个交换网络中计算出一棵无环的“树”(STP树)。

根桥是一个STP交换网络中的“树根"。

STP开始工作后，会在交换网络中选举一个根桥，根桥是生成树进行拓扑计算的重要“参考点”，是STP计算得出的无环拓扑的“树根”。

在STP网络中，桥ID最小的设备会被选举为根桥。在BID的比较过程中，首先比较桥优先级，优先级的值越小则越优先，拥有最小优先级值的交换机会成为根桥;如果优先级相等，那么再比较MAC地址，拥有最小MAC地址的交换机会成为根桥。

对于一个STP网络，根桥在全网中只有一个，它是整个网络的逻辑中心，但不一定是物理中心。根桥会根据网络拓扑的变化而动态变化。

网络收敛后，根桥会按照一定的时间间隔产生并向外发送配置BPDU，其他设备仅对该报文进行处理，传达拓扑变化记录，从而保证拓扑的稳定。

### 开销(Cost）

每一个激活了STP的接口都维护着一个Cost值，接口的Cost主要用于计算根路径开销，也就是到达根的开销。

接口的缺省Cost除了与其速率、工作模式有关，还与交换机使用的STP Cost计算方法有关。

接口带宽越大，则Cost值越小。用户也可以根据需要通过命令调整接口的Cost。

```
接口下：stp cost INTEGER<1-65535>
```

华为交换机支持多种STP的路径开销计算标准，提供多厂商场景下最大程度的兼容性。缺省情况下，华为交换机使用IEEE 802.1t标准来计算路径开销。

```
stp pathcost-standard ?
dot1d-1998
dot1t
legacy
```

### 根路径开销(Root Path Cost）

在STP的拓扑计算过程中，一个非常重要的环节就是“丈量交换机某个接口到根桥的“成本"，也即RPC。

一台设备从某个接口到达根桥的RPC等于从根桥到该设备沿途所有入方向接口的Cost累加。

从一个非根桥到达根桥的路径可能有多条，每一条路径都有一个总的开销值，此开销值是该路径上所有接收BPDU端口的端口开销总和(即BPDU的入方向端口)，称为路径开销。非根桥通过对比多条路径的路径开销，选出到达根桥的最短路径，这条最短路径的路径开销被称为RPC，并生成无环树状网络。根桥的根路径开销是0。

### 接口ID(Port ID，PID)

运行STP的交换机使用接口ID来标识每个接口，接口ID主要用于在特定场景下选举指定接口。

接口ID由两部分构成的，高4bit是接口优先级，低12 bit是接口编号。

激活STP的接口会维护一个缺省的接口优先级，在华为交换机上，该值为128。用户可以根据实际需要，通过命令修改该优先级。

```
接口下：stp port priority INTEGER<0-240>
```

### BPDU(Bridge Protocol Data Unit，网桥协议数据单元)

BPDU是STP能够正常工作的根本。BPDU是STP的协议报文，STP交换机之间会交互BPDU报文，这些BPDU报文携带着些重要信息，正是基于这些信息，STP才能够顺利工作。

BPDU分为两种类型:

- 配置BPDU( Configuration BPDU )
- TCN BPDU ( Topology Change Notification BPDU )

配置BPDU是STP进行拓扑计算的关键;TCN BPDU只在网络拓扑发生变更时才会被触发。

配置BPDU包含了桥ID、路径开销和端口ID等参数。STP协议通过在交换机之间传递配置BPDU来选举根交换机，以及确定每个交换机端口的角色和状态。在初始化过程中，每个桥都主动发送配置BPDU。在网络拓扑稳定以后，只有根桥主动发送配置BPDU，其他交换机在收到上游传来的配置BPDU后，才会发送自己的配置BPDU。

TCN BPDU是指下游交换机感知到拓扑发生变化时向上游发送的拓扑变化通知。

### 配置BPDU的报文格式

[IP 报文格式大全](https://support.huawei.com/hedex/hdx.do?docid=EDOC1000105967&id=ZH-CN_CONCEPT_0254009138)











STP的基础配置
test

RSTP对STP的改进

生成树技术进阶