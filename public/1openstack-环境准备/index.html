<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        openstack - zsjshao
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="初始环境 设备命名、角色及地址 名称 操作系统 IP地址 角色 controller1 CentOS 7.2 192.168.3.71192.168.101.71 控制节点 controller2 CentOS 7.2 192.168.3.72192.168.101.72 控制节点 compute1 CentOS 7.2 192.168.3.73192.168.101.73 计算节点 compute2 CentOS 7.2 192.168.3.74192.168.101.74 计算节点 mariadb1 CentOS 7.2 192.168.3.75192.168.101.75 mariadb master、" />
  <meta name="generator" content="Hugo 0.69.2 with theme pure" />
  <title>openstack - zsjshao</title>
  
  
  <link rel="stylesheet" href="https://www.zsjshao.net:1313/css/style.min.7dc20efbc53647d41aa9ddea0c48e59300223d084e66ea0cbe7c30bd88903acc.css">
  
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
  <meta property="og:title" content="openstack" />
<meta property="og:description" content="初始环境 设备命名、角色及地址 名称 操作系统 IP地址 角色 controller1 CentOS 7.2 192.168.3.71192.168.101.71 控制节点 controller2 CentOS 7.2 192.168.3.72192.168.101.72 控制节点 compute1 CentOS 7.2 192.168.3.73192.168.101.73 计算节点 compute2 CentOS 7.2 192.168.3.74192.168.101.74 计算节点 mariadb1 CentOS 7.2 192.168.3.75192.168.101.75 mariadb master、" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zsjshao.net:1313/1openstack-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/" />
<meta property="article:published_time" content="2019-02-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-02-28T00:00:00+00:00" />
<meta itemprop="name" content="openstack">
<meta itemprop="description" content="初始环境 设备命名、角色及地址 名称 操作系统 IP地址 角色 controller1 CentOS 7.2 192.168.3.71192.168.101.71 控制节点 controller2 CentOS 7.2 192.168.3.72192.168.101.72 控制节点 compute1 CentOS 7.2 192.168.3.73192.168.101.73 计算节点 compute2 CentOS 7.2 192.168.3.74192.168.101.74 计算节点 mariadb1 CentOS 7.2 192.168.3.75192.168.101.75 mariadb master、">
<meta itemprop="datePublished" content="2019-02-28T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-02-28T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1617">



<meta itemprop="keywords" content="openstack," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="openstack"/>
<meta name="twitter:description" content="初始环境 设备命名、角色及地址 名称 操作系统 IP地址 角色 controller1 CentOS 7.2 192.168.3.71192.168.101.71 控制节点 controller2 CentOS 7.2 192.168.3.72192.168.101.72 控制节点 compute1 CentOS 7.2 192.168.3.73192.168.101.73 计算节点 compute2 CentOS 7.2 192.168.3.74192.168.101.74 计算节点 mariadb1 CentOS 7.2 192.168.3.75192.168.101.75 mariadb master、"/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/zsjshao" target="_blank">
            <img class="img-circle img-rotate" src="https://www.zsjshao.net:1313/avatar.png" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">zsjshao</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>gz, China</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="想要查找什么..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts/">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about/">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p>个人博客~</p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <h3 class="widget-title"> 分类</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://www.zsjshao.net:1313/categories/go/" class="category-list-link">go</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://www.zsjshao.net:1313/categories/openstack/" class="category-list-link">openstack</a><span class="category-list-count">2</span></li>
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> 标签</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://www.zsjshao.net:1313/tags/go/" class="tag-list-link">go</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://www.zsjshao.net:1313/tags/openstack/" class="tag-list-link">openstack</a><span
                    class="tag-list-count">2</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://www.zsjshao.net:1313/go/" class="title">go</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2019-02-28 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-02-28</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://www.zsjshao.net:1313/1openstack-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/" class="title">openstack</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2019-02-28 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-02-28</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://www.zsjshao.net:1313/2openstack-%E7%AE%80%E4%BB%8B/" class="title">openstack</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2019-02-28 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-02-28</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">文章目录</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/1openstack-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/"
    >openstack</a
  >
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://www.zsjshao.net:1313/1openstack-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/" class="article-date">
  <time datetime="2019-02-28 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-02-28</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>&nbsp;
  <a class="article-category-link" href="/categories/openstack/"> openstack </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>&nbsp;
    <a class="article-tag-link" href="/tags/openstack/"> openstack </a>
  </span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/1openstack-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/#comments"
            class="article-comment-link">评论</a></span>
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 1617字</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 4分 </span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <h2 id="初始环境">初始环境</h2>
<!-- raw HTML omitted -->
<h3 id="设备命名角色及地址">设备命名、角色及地址</h3>
<table>
<thead>
<tr>
<th>名称</th>
<th>操作系统</th>
<th>IP地址</th>
<th>角色</th>
</tr>
</thead>
<tbody>
<tr>
<td>controller1</td>
<td>CentOS 7.2</td>
<td>192.168.3.71<!-- raw HTML omitted -->192.168.101.71</td>
<td>控制节点</td>
</tr>
<tr>
<td>controller2</td>
<td>CentOS 7.2</td>
<td>192.168.3.72<!-- raw HTML omitted -->192.168.101.72</td>
<td>控制节点</td>
</tr>
<tr>
<td>compute1</td>
<td>CentOS 7.2</td>
<td>192.168.3.73<!-- raw HTML omitted -->192.168.101.73</td>
<td>计算节点</td>
</tr>
<tr>
<td>compute2</td>
<td>CentOS 7.2</td>
<td>192.168.3.74<!-- raw HTML omitted -->192.168.101.74</td>
<td>计算节点</td>
</tr>
<tr>
<td>mariadb1</td>
<td>CentOS 7.2</td>
<td>192.168.3.75<!-- raw HTML omitted -->192.168.101.75</td>
<td>mariadb master、rabbitmq cluster、memcached cluster</td>
</tr>
<tr>
<td>mariadb2</td>
<td>CentOS 7.2</td>
<td>192.168.3.76<!-- raw HTML omitted -->192.168.101.76</td>
<td>mariadb slave、rabbitmq cluster、memcached cluster</td>
</tr>
<tr>
<td>haproxy1</td>
<td>CentOS 8.1</td>
<td>192.168.3.81<!-- raw HTML omitted -->192.168.101.81<!-- raw HTML omitted -->vip:192.168.3.200<!-- raw HTML omitted -->vip:192.168.101.200</td>
<td>keepalived、haproxy</td>
</tr>
<tr>
<td>haproxy2</td>
<td>CentOS 8.1</td>
<td>192.168.3.81<!-- raw HTML omitted -->192.168.101.81<!-- raw HTML omitted -->vip:192.168.3.200<!-- raw HTML omitted -->vip:192.168.101.200</td>
<td>keepalived、haproxy</td>
</tr>
</tbody>
</table>
<h3 id="mariadb主从">mariadb主/从</h3>
<pre><code>mariadb主
[root@mariadb1 ~]# yum install centos-release-openstack-queens -y

[root@mariadb1 ~]# yum install mariadb-server -y
[root@mariadb1 ~]# vim /etc/my.cnf.d/openstack.cnf
...
[mysqld]
bind-address = 192.168.101.75

default-storage-engine = innodb
innodb_file_per_table = on
max_connections = 4096
collation-server = utf8_general_ci
character-set-server = utf8

log_bin=mysql-bin
server_id=1
skip_name_resolve=ON

[root@mariadb1 ~]# systemctl start mariadb
[root@mariadb1 ~]# systemctl enable mariadb
[root@mariadb1 ~]# mysql -e 'GRANT REPLICATION SLAVE ON *.* TO &quot;repluser&quot;@&quot;192.168.101.76&quot; IDENTIFIED BY &quot;replpass&quot;;'

mariadb从
[root@mariadb2 ~]# yum install centos-release-openstack-queens -y

[root@mariadb2 ~]# yum install mariadb-server -y
[root@mariadb2 ~]# vim /etc/my.cnf.d/openstack.cnf
...
[mysqld]
bind-address = 192.168.101.76

default-storage-engine = innodb
innodb_file_per_table = on
max_connections = 4096
collation-server = utf8_general_ci
character-set-server = utf8

server_id=2
read_only=ON
skip_name_resolve=ON

[root@mariadb2 ~]# systemctl start mariadb
[root@mariadb2 ~]# systemctl enable mariadb
[root@mariadb2 ~]# mysql -e 'change master to master_host=&quot;192.168.101.75&quot;,master_user=&quot;repluser&quot;,master_password=&quot;replpass&quot;,master_log_file=&quot;mysql-bin.000001&quot;,master_log_pos=512'
[root@mariadb2 ~]# mysql -e 'start slave'
</code></pre>
<h3 id="rabbitmq集群">rabbitmq集群</h3>
<pre><code>[root@mariadb2 ~]# yum install rabbitmq-server -y
[root@mariadb2 ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.101.75	mariadb1
192.168.101.76	mariadb2
[root@mariadb2 ~]# systemctl start rabbitmq-server
[root@mariadb2 ~]# systemctl enable rabbitmq-server
[root@mariadb2 ~]# rabbitmq-plugins enable rabbitmq_management
[root@mariadb2 ~]# rabbitmqctl cluster_status

[root@mariadb1 ~]# yum install rabbitmq-server -y
[root@mariadb1 ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.101.75	mariadb1
192.168.101.76	mariadb2
[root@mariadb1 ~]# systemctl start rabbitmq-server
[root@mariadb1 ~]# systemctl enable rabbitmq-server
[root@mariadb1 ~]# rabbitmq-plugins enable rabbitmq_management
[root@mariadb1 ~]# scp /var/lib/rabbitmq/.erlang.cookie 192.168.3.76:/var/lib/rabbitmq/
[root@mariadb1 ~]# rabbitmqctl stop_app
[root@mariadb1 ~]# rabbitmqctl reset
[root@mariadb1 ~]# rabbitmqctl join_cluster rabbit@mariadb2 --ram
[root@mariadb1 ~]# rabbitmqctl start_app
[root@mariadb1 ~]# rabbitmqctl cluster_status
[root@mariadb1 ~]# rabbitmqctl set_policy  ha-all &quot;#&quot;  '{&quot;ha-mode&quot;:&quot;all&quot;}'

[root@mariadb1 ~]# rabbitmqctl add_user openstack openstack
[root@mariadb1 ~]# rabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;
</code></pre>
<h3 id="memcached集群">memcached集群</h3>
<pre><code>[root@mariadb1 ~]# yum install memcached libevent libevent-devel -y
[root@mariadb1 src]# wget https://sourceforge.net/projects/repcached/files/repcached/2.2.1-1.2.8/memcached-1.2.8-repcached-2.2.1.tar.gz
[root@mariadb1 src]# tar xf memcached-1.2.8-repcached-2.2.1.tar.gz 
[root@mariadb1 src]# cd memcached-1.2.8-repcached-2.2.1/
[root@mariadb1 memcached-1.2.8-repcached-2.2.1]# ./configure --prefix=/usr/local/repached --enable-replication
[root@mariadb1 memcached-1.2.8-repcached-2.2.1]# vim memcached.c
修改前
/* FreeBSD 4.x doesn't have IOV_MAX exposed. */
#ifndef IOV_MAX
#if defined(__FreeBSD__) || defined(__APPLE__)
# define IOV_MAX 1024
#endif
#endif

修改后
/* FreeBSD 4.x doesn't have IOV_MAX exposed. */
#ifndef IOV_MAX
# define IOV_MAX 1024
#endif
[root@mariadb1 memcached-1.2.8-repcached-2.2.1]# make &amp;&amp; make install
[root@mariadb1 ~]# /usr/local/repached/bin/memcached -d -m 2048 -p 11211 -u root -c 2048 -x 192.168.101.76
[root@mariadb1 ~]# vim /etc/rc.d/rc.local
...
/usr/local/repached/bin/memcached -d -m 2048 -p 11211 -u root -c 2048 -x 192.168.101.76

[root@mariadb1 ~]# chmod +x /etc/rc.d/rc.local

[root@mariadb1 ~]# scp /usr/local/src/memcached-1.2.8-repcached-2.2.1.tar.gz 192.168.101.76:/usr/local/src


[root@mariadb2 src]# tar xf memcached-1.2.8-repcached-2.2.1.tar.gz 
[root@mariadb2 src]# cd memcached-1.2.8-repcached-2.2.1/
[root@mariadb2 memcached-1.2.8-repcached-2.2.1]# ./configure --prefix=/usr/local/repached --enable-replication
[root@mariadb2 memcached-1.2.8-repcached-2.2.1]# vim memcached.c 
修改前
/* FreeBSD 4.x doesn't have IOV_MAX exposed. */
#ifndef IOV_MAX
#if defined(__FreeBSD__) || defined(__APPLE__)
# define IOV_MAX 1024
#endif
#endif

修改后
/* FreeBSD 4.x doesn't have IOV_MAX exposed. */
#ifndef IOV_MAX
# define IOV_MAX 1024
#endif

[root@mariadb2 memcached-1.2.8-repcached-2.2.1]# make &amp;&amp; make install
[root@mariadb2 memcached-1.2.8-repcached-2.2.1]# /usr/local/repached/bin/memcached -d -m 2048 -p 11211 -u root -c 2048 -x 192.168.101.75

[root@mariadb1 ~]# vim /etc/rc.d/rc.local
...
/usr/local/repached/bin/memcached -d -m 2048 -p 11211 -u root -c 2048 -x 192.168.101.76

[root@mariadb1 ~]# chmod +x /etc/rc.d/rc.local
</code></pre>
<h3 id="时间同步">时间同步</h3>
<pre><code>控制节点
[root@controller1 ~]# yum install chrony -y
[root@controller1 ~]# vim /etc/chrony.conf
...
allow 192.168.3.0/24
allow 192.168.101.0/24


[root@controller1 ~]# systemctl start chronyd
[root@controller1 ~]# systemctl enable chronyd

其他节点
[root@controller2 ~]# yum install chrony -y
[root@controller2 ~]# vim /etc/chrony.conf
...
server 192.168.101.71 iburst

[root@controller2 ~]# systemctl start chronyd
[root@controller2 ~]# systemctl enable chronyd

</code></pre>
<h3 id="keepalived">keepalived</h3>
<pre><code>[root@haproxy1 ~]# dnf install keepalived -y
[root@haproxy1 ~]# cat /etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   notification_email {
     root@zsjshao.net
   }
   notification_email_from keepalived@zsjshao.net
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id c81
   vrrp_skip_check_adv_addr
   vrrp_strict
   vrrp_iptables
   vrrp_garp_interval 0
   vrrp_gna_interval 0
}

vrrp_instance VI_1 {
    state MASTER
    interface br1
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 123456
    }
    virtual_ipaddress {
        192.168.101.200 dev br1 label br1:0
    }
}
vrrp_instance VI_2 {
    state BACKUP
    interface br2
    virtual_router_id 52
    priority 80
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 123456
    }
    virtual_ipaddress {
        192.168.3.200 dev br2 label br2:0
    }
}
[root@haproxy1 ~]# systemctl start keepalived
[root@haproxy1 ~]# systemctl enable keepalived



[root@haproxy2 ~]# dnf install keepalived -y
[root@haproxy2 ~]# cat /etc/keepalived/keepalived.conf 
! Configuration File for keepalived

global_defs {
   notification_email {
     root@zsjshao.net
   }
   notification_email_from keepalived@zsjshao.net
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id c82
   vrrp_skip_check_adv_addr
   vrrp_strict
   vrrp_iptables
   vrrp_garp_interval 0
   vrrp_gna_interval 0
}

vrrp_instance VI_1 {
    state BACKUP
    interface br1
    virtual_router_id 51
    priority 80
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 123456
    }
    virtual_ipaddress {
        192.168.101.200 dev br1 label br1:0
    }
}
vrrp_instance VI_2 {
    state MASTER
    interface br2
    virtual_router_id 52
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 123456
    }
    virtual_ipaddress {
        192.168.3.200 dev br2 label br2:0
    }
}
[root@haproxy2 ~]# systemctl start keepalived
[root@haproxy2 ~]# systemctl enable keepalived
</code></pre>
<h3 id="haproxy">haproxy</h3>
<pre><code>[root@c81 ~]# dnf install haproxy 
[root@haproxy1 ~]# cat /etc/haproxy/haproxy.cfg 
global
    maxconn 100000
#   chroot /usr/local/haproxy
    #stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin
    uid 995
    gid 992
    daemon
    nbproc 4
    cpu-map 1 0
    cpu-map 2 1
    cpu-map 3 2
    cpu-map 4 3
    pidfile /var/run/haproxy.pid
    log 127.0.0.1 local3 info

defaults
    option http-keep-alive
    option  forwardfor
    maxconn 100000
    mode http
    timeout connect 300000ms
    timeout client  300000ms
    timeout server  300000ms

listen stats
    bind :9999
    stats enable
    stats hide-version
    stats uri /haproxy-status
    stats realm HAPorxy\Stats\Page
    stats auth haadmin:123456
    stats refresh 30s
    stats admin if TRUE

listen  dashboard_ex_80
    bind 192.168.3.200:80
    mode tcp
    server web1  192.168.3.71:80  check inter 3000 fall 2 rise 5
    server web2  192.168.3.72:80  check inter 3000 fall 2 rise 5

listen  dashboard_in_80
    bind 192.168.101.200:80
    mode tcp
    server web1  192.168.101.71:80  check inter 3000 fall 2 rise 5
    server web2  192.168.101.72:80  check inter 3000 fall 2 rise 5

listen  mariadb_3306
    bind 192.168.101.200:3306
    mode tcp
    server mariadb1  192.168.101.75:3306  check inter 3000 fall 2 rise 5
    server mariadb2  192.168.101.76:3306  check inter 3000 fall 2 rise 5 backup

listen  rabbitmq_5672
    bind 192.168.101.200:5672
    mode tcp
    balance source
    server rabbitmq1  192.168.101.75:5672  check inter 3000 fall 2 rise 5
    server rabbitmq2  192.168.101.76:5672  check inter 3000 fall 2 rise 5

listen  rabbitmq_web_15672
    bind 192.168.3.200:15672
    mode tcp
    balance source
    server rabbitmq1  192.168.3.75:15672  check inter 3000 fall 2 rise 5
    server rabbitmq2  192.168.3.76:15672  check inter 3000 fall 2 rise 5

listen  memcached_11211
    bind 192.168.101.200:11211
    mode tcp
    balance source
    server memcached1  192.168.101.75:11211  check inter 3000 fall 2 rise 5
    server memcached2  192.168.101.76:11211  check inter 3000 fall 2 rise 5

listen keystone_5000
    bind 192.168.101.200:5000
    mode tcp
    server controller1 192.168.101.71:5000 check inter 3000 fall 2 rise 5
    server controller2 192.168.101.72:5000 check inter 3000 fall 2 rise 5

listen keystone_35357
    bind 192.168.101.200:35357
    mode tcp
    server controller1 192.168.101.71:35357 check inter 3000 fall 2 rise 5
    server controller2 192.168.101.72:35357 check inter 3000 fall 2 rise 5

listen glance_9292
    bind 192.168.101.200:9292
    mode tcp
    server controller1 192.168.101.71:9292 check inter 3000 fall 2 rise 5
    server controller2 192.168.101.72:9292 check inter 3000 fall 2 rise 5

listen nova_8774
    bind 192.168.101.200:8774
    mode tcp
    server nova1 192.168.101.71:8774 check inter 3000 fall 2 rise 5
    server nova2 192.168.101.72:8774 check inter 3000 fall 2 rise 5

listen metadata_8775
    bind 192.168.101.200:8775
    mode tcp
    server metadata1 192.168.101.71:8775 check inter 3000 fall 2 rise 5
    server metadata2 192.168.101.72:8775 check inter 3000 fall 2 rise 5

listen placement_8778
    bind 192.168.101.200:8778
    mode tcp
    server placement1 192.168.101.71:8778 check inter 3000 fall 2 rise 5
    server placement2 192.168.101.72:8778 check inter 3000 fall 2 rise 5

listen nova_vnc_6080
    bind 192.168.101.200:6080
    mode tcp
    server nova_vnc1 192.168.101.71:6080 check inter 3000 fall 2 rise 5
    server nova_vnc2 192.168.101.72:6080 check inter 3000 fall 2 rise 5

listen neutron_9696
    bind 192.168.101.200:9696
    mode tcp
    server neutron1 192.168.101.71:9696 check inter 3000 fall 2 rise 5
    server neutron2 192.168.101.72:9696 check inter 3000 fall 2 rise 5

[root@c81 ~]# systemctl start haproxy
[root@c81 ~]# systemctl enable haproxy
</code></pre>
<h3 id="etcd">etcd</h3>
<pre><code>[root@controller1 ~]# yum install etcd -y
[root@controller1 ~]# grep -v ^# /etc/etcd/etcd.conf 
ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;
ETCD_LISTEN_PEER_URLS=&quot;http://192.168.101.71:2380,http://127.0.0.1:2380&quot;
ETCD_LISTEN_CLIENT_URLS=&quot;http://192.168.101.71:2379,http://127.0.0.1:2379&quot;
ETCD_NAME=&quot;controller1&quot;
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://192.168.101.71:2380&quot;
ETCD_ADVERTISE_CLIENT_URLS=&quot;http://192.168.101.71:2379&quot;
ETCD_INITIAL_CLUSTER=&quot;controller1=http://192.168.101.71:2380,controller2=http://192.168.101.72:2380&quot;
ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;
[root@controller1 ~]# systemctl start etcd
[root@controller1 ~]# systemctl enable etcd

[root@controller2 ~]# yum install etcd -y
[root@controller2 ~]# grep -v ^# /etc/etcd/etcd.conf
ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;
ETCD_LISTEN_PEER_URLS=&quot;http://192.168.101.72:2380,http://127.0.0.1:2380&quot;
ETCD_LISTEN_CLIENT_URLS=&quot;http://192.168.101.72:2379,http://127.0.0.1:2379&quot;
ETCD_NAME=&quot;controller2&quot;
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;http://192.168.101.72:2380&quot;
ETCD_ADVERTISE_CLIENT_URLS=&quot;http://192.168.101.72:2379&quot;
ETCD_INITIAL_CLUSTER=&quot;controller1=http://192.168.101.71:2380,controller2=http://192.168.101.72:2380&quot;
ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;existing&quot;
[root@controller2 ~]# systemctl start etcd
[root@controller2 ~]# systemctl enable etcd

[root@controller1 ~]# etcdctl member list
436615ac15609671: name=controller2 peerURLs=http://192.168.101.72:2380 clientURLs=http://192.168.101.72:2379 isLeader=true
74492978ad38fdfd: name=controller1 peerURLs=http://192.168.101.71:2380 clientURLs=http://192.168.101.71:2379 isLeader=false
</code></pre>
<h3 id="各节点添加yum源安装openstack客户端">各节点添加yum源，安装OpenStack客户端</h3>
<pre><code>[root@controller1 ~]# yum install centos-release-openstack-queens -y
[root@controller1 ~]# yum install python-openstackclient python-memcached -y

若启用SELinux，需安装openstack-selinux软件包以自动管理openstack服务的安全策略
# yum install openstack-selinux -y
</code></pre>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接: </strong>
      <a href="https://www.zsjshao.net:1313/1openstack-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/" title="openstack" target="_blank" rel="external">https://www.zsjshao.net:1313/1openstack-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License：</strong><a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/zsjshao" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://www.zsjshao.net:1313/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/zsjshao" target="_blank"><span class="text-dark">zsjshao</span><small class="ml-1x"></small></a></h3>
        <div>Good Good Study, Day Day Up~</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>
<section id="comments">
</section>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://www.zsjshao.net:1313/2openstack-%E7%AE%80%E4%BB%8B/" title="openstack"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;下一篇</span></a>
            </li>
            <li class="next">
                <a href="https://www.zsjshao.net:1313/go/"
                    title="go"><span>上一篇&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="文章目录" role="button">
                    <span>[&nbsp;</span><span>文章目录</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/zsjshao" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://www.zsjshao.net:1313/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2020  -
    2020
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://www.zsjshao.net:1313/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://www.zsjshao.net:1313/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(未命名)',
            },
            ROOT_URL: 'https:\/\/www.zsjshao.net:1313\/',
            CONTENT_URL: 'https:\/\/www.zsjshao.net:1313\/\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://www.zsjshao.net:1313/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
